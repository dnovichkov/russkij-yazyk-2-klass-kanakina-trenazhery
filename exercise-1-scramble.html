<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî —Å–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ –∏–∑ –±—É–∫–≤</title>
<style>
  :root{
    --bg:#f3f4f4; --card:#fff; --accent:#0f62fe; --muted:#6b7280;
    --wrong:#ff4d4f;
  }
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);margin:0;color:#0b1220}
  header{padding:18px;text-align:center;background:white;box-shadow:0 1px 0 rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:1.05rem}
  header .home{margin-left:auto;text-decoration:none;background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px}
  main{max-width:920px;margin:18px auto;padding:16px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button, .btn{background:var(--accent);color:white;border:none;padding:10px;border-radius:10px;cursor:pointer}
  .btn.alt{background:#6b7280}
  .btn[disabled]{opacity:0.5;cursor:not-allowed}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04);margin-bottom:12px}
  .scramble{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
  .tile{min-width:44px;min-height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:1px solid #e6eef8;font-size:20px;cursor:pointer;user-select:none}
  .tile.hidden{visibility:hidden}
  .slots{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
  .slot{min-width:44px;min-height:44px;border-radius:8px;background:#fff;border:2px dashed #e6eef8;display:flex;align-items:center;justify-content:center;font-size:20px;position:relative}
  .slot.space{background:transparent;border:0;min-width:30px}
  .slot.wrong{box-shadow:0 0 0 3px rgba(255,77,79,0.12); border-color:var(--wrong)}
  .status{margin-top:12px;color:var(--muted)}
  .hint{background:#f9fafb;color:#374151;border-radius:8px;padding:6px}
  .drop-indicator{position:absolute;inset:0;border-radius:8px;pointer-events:none}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <a class="home" href="index.html" style="margin-left:0">üè† –î–æ–º–æ–π</a>
    <h1 style="margin:0;font-size:1.05rem">–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî —Å–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ –∏–∑ –±—É–∫–≤</h1>
  </div>
</header>

<main>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="controls">
        <button id="playBtn">‚ñ∂ –î–∏–∫—Ç–æ–≤–∫–∞</button>
        <button id="hintBtn" class="btn alt">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ (—Å–ª–µ–¥—É—é—â–∞—è –±—É–∫–≤–∞)</button>
        <button id="shuffleBtn" class="btn alt">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      </div>
      <div>
        <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="nextBtn" class="btn alt">–°–ª–µ–¥—É—é—â–µ–µ</button>
      </div>
    </div>

    <div style="margin-top:12px" class="status">
      <strong>–ü—Ä–æ–≥—Ä–µ—Å—Å:</strong> <span id="progress">0 / 0</span>
    </div>

    <div style="margin-top:16px">
      <div class="card">
        <div><strong>–ë—É–∫–≤—ã:</strong></div>
        <div id="bank" class="scramble" aria-live="polite"></div>
        <div style="margin-top:8px"><small class="hint">–ö–ª–∏–∫ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±—É–∫–≤—É –≤ –Ω—É–∂–Ω—É—é —è—á–µ–π–∫—É. –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –±—É–∫–≤—É ‚Äî –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∑–∞–ø–æ–ª–Ω—ë–Ω–Ω–æ–π —è—á–µ–π–∫–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ—ë –æ–±—Ä–∞—Ç–Ω–æ.</small></div>
      </div>

      <div class="card">
        <div><strong>–°–æ–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–æ:</strong></div>
        <div id="slots" class="slots" aria-live="polite"></div>
      </div>

      <div id="feedback" style="margin-top:8px;font-weight:600;"></div>
    </div>
  </div>

  <div class="card">
    <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
    <ol>
      <li>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é <strong>–ø—É—Å—Ç—É—é</strong> –±—É–∫–≤—É –ø–æ –ø–æ—Ä—è–¥–∫—É.</li>
      <li>–ï—Å–ª–∏ –Ω—É–∂–Ω–æ–π –±—É–∫–≤—ã –Ω–µ—Ç –≤ –±–∞–Ω–∫–µ, –Ω–æ –æ–Ω–∞ –µ—Å—Ç—å –≤ –¥—Ä—É–≥–æ–º —Å–ª–æ—Ç–µ ‚Äî –æ–Ω–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞ —Å–≤–æ—ë –º–µ—Å—Ç–æ.</li>
      <li>–ö–æ–≥–¥–∞ –≤—Å–µ –±—É–∫–≤—ã –æ—Ç–∫—Ä—ã—Ç—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è.</li>
      <li>–ü—Ä–æ–≥—Ä–µ—Å—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ.</li>
    </ol>
  </div>
</main>

<script>
/* ============================
   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥–∞
   ============================ */
const AUTO_NEXT_DELAY = 600;
let autoNextTimeoutId = null;

/* ============================
   –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤
   ============================ */
const WORDS = [
"–∞–ª—Ñ–∞–≤–∏—Ç","–∞–ø—Ä–µ–ª—å","–±–µ—Ä—ë–∑–∞","–±—ã—Å—Ç—Ä–æ","–≤–¥—Ä—É–≥","–≤–µ—Å–µ–ª–æ","–≤–µ—Ç–µ—Ä","–≤–æ—Ä–æ–±–µ–π","–≤–æ—Ä–æ–Ω–∞",
"–≥–æ—Ä–æ–¥","–¥–µ–≤–æ—á–∫–∞","–¥–µ–∂—É—Ä–Ω—ã–π","–¥–µ–∫–∞–±—Ä—å","–¥–µ—Ä–µ–≤–Ω—è","–¥–æ—Ä–æ–≥–∞","–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è",
"–∑–∞–≤–æ–¥","–∑–∞—è—Ü","–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ","–∑–µ–º–ª—è–Ω–∏–∫–∞","–∏–∑–≤–∏–Ω–∏—Ç–µ","–∏–Ω–µ–π","–∫–∞–ø—É—Å—Ç–∞","–∫–∞—Ä–∞–Ω–¥–∞—à",
"–∫–∞—Ä—Ç–∏–Ω–∞","–∫–ª–∞—Å—Å","–∫–æ–Ω—å–∫–∏","–∫–æ—Ä–æ–≤–∞","–ª–æ–ø–∞—Ç–∞","–ª—è–≥—É—à–∫–∞","–º–∞–≥–∞–∑–∏–Ω","–º–∞–ª–∏–Ω–∞","–º–∞—à–∏–Ω–∞",
"–º–µ–±–µ–ª—å","–º–µ–¥–≤–µ–¥—å","–º–µ—Å—è—Ü","–º–µ—Ç–µ–ª—å","–º–µ—Ç—Ä–æ","–º–æ–ª–æ–∫–æ","–º–æ–ª–æ—Ç–æ–∫","–º–æ—Ä–∫–æ–≤—å","–º–æ—Ä–æ–∑","–º–æ—Å–∫–≤–∞",
"–Ω–∞—Ä–æ–¥","–Ω–æ—è–±—Ä—å","–æ–±–µ–¥","–æ–±–µ–∑—å—è–Ω–∞","–æ–±–ª–∞–∫–æ","–æ–¥–µ–∂–¥–∞","–æ–∫—Ç—è–±—Ä—å","–æ—Å–∏–Ω–∞","–æ—Ç–µ—Ü",
"–ø–∞–ª—å—Ç–æ","–ø–µ–Ω–∞–ª","–ø–µ—Ç—É—Ö","–ø–ª–∞—Ç—å–µ","–ø–æ—Å—É–¥–∞","–ø—Ä–æ—â–∞–π","—Ä–∞–±–æ—Ç–∞","—Ä–∞–±–æ—á–∏–π","—Ä–µ–±—è—Ç–∞","—Ä–∏—Å—É–Ω–æ–∫",
"—Ä–æ–¥–∏–Ω–∞","—Ä–æ—Å—Å–∏—è","—Ä—É—Å—Å–∫–∏–π","—Å–∞–ø–æ–≥–∏","—Å–∞—Ö–∞—Ä","—Å–µ–Ω—Ç—è–±—Ä—å","—Å–∫–æ—Ä–æ","—Å–Ω–µ–≥–∏—Ä—å","—Å–æ–±–∞–∫–∞","—Å–æ—Ä–æ–∫–∞",
"—Å–ø–∞—Å–∏–±–æ","—Å—Ç–∞–∫–∞–Ω","—Å—É–±–±–æ—Ç–∞","—Ç–∞—Ä–µ–ª–∫–∞","—Ç–µ—Ç—Ä–∞–¥—å","—Ç–æ–≤–∞—Ä–∏—â","—Ç–æ–ø–æ—Ä","—É–ª–∏—Ü–∞","—É—Ä–æ–∂–∞–π",
"—É—á–µ–Ω–∏–∫","—É—á–µ–Ω–∏—Ü–∞","—É—á–∏—Ç–µ–ª—å","—É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞","—Ñ–∞–º–∏–ª–∏—è","—Ñ–µ–≤—Ä–∞–ª—å","—Ö–æ—Ä–æ—à–æ","—â–∞–≤–µ–ª—å",
"—è–±–ª–æ–∫–æ","—è–±–ª–æ–Ω—è","—è–≥–æ–¥–∞","—è–∑—ã–∫","—è–Ω–≤–∞—Ä—å"
];

/* ============================
   –°–æ—Å—Ç–æ—è–Ω–∏–µ
   - idx: –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ –≤ pool (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ)
   - completed: —Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ)
   ============================ */
let pool = [];
let idx = 0;
let completed = 0;
let current = "";
let slotsState = [];
const progressEl = document.getElementById('progress');
const bankEl = document.getElementById('bank');
const slotsEl = document.getElementById('slots');
const feedback = document.getElementById('feedback');
const hintBtn = document.getElementById('hintBtn');

/* ============================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
   ============================ */
function initPool() {
  pool = [...WORDS];
  pool.sort(()=>Math.random()-0.5);
  idx = 0;
  completed = 0;
  updateProgress();
}
function updateProgress(){ progressEl.textContent = `${completed} / ${pool.length}` }

/* ============================
   TTS
   ============================ */
let voices = [];
function loadVoices(){ voices = speechSynthesis.getVoices() || []; }
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function waitVoices(timeout = 1000) {
  return new Promise(resolve => {
    loadVoices();
    if ((speechSynthesis.getVoices() || []).some(v => v.lang && v.lang.toLowerCase().startsWith('ru'))) {
      resolve(true);
      return;
    }
    let waited = 0;
    const step = 150;
    const iv = setInterval(()=>{
      loadVoices();
      waited += step;
      if ((speechSynthesis.getVoices() || []).some(v => v.lang && v.lang.toLowerCase().startsWith('ru')) || waited >= timeout) {
        clearInterval(iv);
        resolve(true);
      }
    }, step);
  });
}

function chooseRussianVoice(){
  const vs = speechSynthesis.getVoices() || [];
  let v = vs.find(x => x.lang && x.lang.toLowerCase().startsWith('ru'));
  if (!v) v = vs.find(x => /russian/i.test(x.name));
  return v || null;
}

function speakText(text, rate=0.95){
  if (!('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  const v = chooseRussianVoice();
  if (v) utter.voice = v;
  utter.rate = rate;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

/* ============================
   –†–µ–Ω–¥–µ—Ä –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–æ—Ç–æ–≤/–ø–ª–∏—Ç–æ–∫
   ============================ */
function prepareWord(w) {
  current = w;
  const letters = Array.from(w);
  const tiles = letters.filter(ch => ch !== ' ');
  const timestamp = Date.now();
  const tilesWithId = tiles.map((ch,i)=> ({ch, id:`tile-${i}-${timestamp}-${Math.floor(Math.random()*10000)}`} ));
  for (let i = tilesWithId.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [tilesWithId[i], tilesWithId[j]] = [tilesWithId[j], tilesWithId[i]];
  }
  renderBank(tilesWithId);
  renderSlots(letters);
  feedback.textContent = '';
  // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ —Å–ª–æ–≤–æ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –ø–∞—É–∑—ã –∏ –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤
  waitVoices(1000).then(()=> setTimeout(()=> speakText(current, 0.95), 150));
  // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
  updateHintButtonState();
}

function renderBank(tiles) {
  bankEl.innerHTML = '';
  tiles.forEach(tile => {
    const btn = document.createElement('div');
    btn.className = 'tile';
    btn.textContent = tile.ch;
    btn.dataset.letter = tile.ch;
    btn.dataset.id = tile.id;
    btn.draggable = true;
    // —É–¥–∞–ª–∏–ª per-item click handler ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ bankEl
    btn.addEventListener('dragstart', onTileDragStart);
    bankEl.appendChild(btn);
  });
  // (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∏–∂–µ)
}

function renderSlots(letters){
  slotsState = letters.map(ch => (ch===' ' ? {ch:' ', tileId:null} : {ch:'', tileId:null}));
  slotsEl.innerHTML = '';
  letters.forEach((ch,i) => {
    const s = document.createElement('div');
    s.className = 'slot' + (ch===' ' ? ' space' : '');
    s.dataset.pos = i;
    s.dataset.accepts = ch===' ' ? 'no' : 'yes';
    s.addEventListener('click', onSlotClick);
    s.addEventListener('dragover', onSlotDragOver);
    s.addEventListener('drop', onSlotDrop);
    s.addEventListener('dragenter', onSlotDragEnter);
    s.addEventListener('dragleave', onSlotDragLeave);
    s.setAttribute('aria-label', ch===' ' ? '–ø—Ä–æ–±–µ–ª' : `—Å–ª–æ—Ç ${i+1}`);
    const content = document.createElement('div');
    content.className = 'slot-content';
    content.style.pointerEvents = 'none';
    content.textContent = ch===' ' ? ' ' : '';
    s.appendChild(content);
    slotsEl.appendChild(s);
  });
  updateSlotsUI();
}

/* ============================
   –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–∫ –ø–æ –±—É–∫–≤–µ (robust)
   ============================ */
bankEl.addEventListener('click', function onBankContainerClick(e){
  const tileEl = e.target.closest('.tile');
  if (!tileEl || !bankEl.contains(tileEl)) return;
  // –µ—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ —Å–∫—Ä—ã—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è), –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º
  if (tileEl.classList.contains('hidden')) return;
  const tileId = tileEl.dataset.id;
  const letter = tileEl.dataset.letter;
  const pos = slotsState.findIndex(v => v.ch === '');
  if (pos === -1) return;
  placeTileToSlot(tileId, letter, pos);
  updateHintButtonState();
});

/* ============================
   –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ: drag&drop (tile dragstart, slot dragstart –∏ —Ç.–¥.)
   ============================ */
function onTileDragStart(e){
  const tileEl = e.currentTarget;
  e.dataTransfer.setData('text/plain', JSON.stringify({
    from: 'bank',
    id: tileEl.dataset.id,
    letter: tileEl.dataset.letter
  }));
  if (e.dataTransfer.setDragImage) {
    const crt = tileEl.cloneNode(true);
    crt.style.position='absolute'; crt.style.top='-1000px'; crt.style.left='-1000px';
    document.body.appendChild(crt);
    e.dataTransfer.setDragImage(crt, 20, 20);
    setTimeout(()=> document.body.removeChild(crt), 0);
  }
}

function onSlotDragStart(e){
  const slot = e.currentTarget;
  const pos = Number(slot.dataset.pos);
  const info = slotsState[pos];
  if (!info || !info.tileId) { e.preventDefault(); return; }
  e.dataTransfer.setData('text/plain', JSON.stringify({
    from: 'slot',
    id: info.tileId,
    letter: info.ch,
    pos
  }));
}

function onSlotDragOver(e){ e.preventDefault(); }
function onSlotDragEnter(e){ e.currentTarget.classList.add('dragover'); }
function onSlotDragLeave(e){ e.currentTarget.classList.remove('dragover'); }

function onSlotDrop(e){
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  let payload;
  try { payload = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err){ return; }
  const pos = Number(e.currentTarget.dataset.pos);
  if (e.currentTarget.dataset.accepts === 'no') return;
  if (payload.from === 'bank'){
    if (slotsState[pos].tileId){
      showTileById(slotsState[pos].tileId);
    }
    placeTileToSlot(payload.id, payload.letter, pos);
    updateHintButtonState();
  } else if (payload.from === 'slot'){
    const fromPos = payload.pos;
    if (fromPos === pos) return;
    const targetTile = slotsState[pos];
    const fromTile = slotsState[fromPos];
    slotsState[pos] = { ch: fromTile.ch, tileId: fromTile.tileId };
    slotsState[fromPos] = { ch: targetTile.ch || '', tileId: targetTile.tileId || null };
    updateSlotsUI();
    updateHintButtonState();
  }
}

function placeTileToSlot(tileId, letter, pos){
  const tileEl = findTileElById(tileId);
  if (!tileEl) return;
  tileEl.classList.add('hidden');
  if (slotsState[pos].tileId){
    showTileById(slotsState[pos].tileId);
  }
  slotsState[pos] = { ch: letter, tileId };
  const slotEl = slotsEl.querySelector(`.slot[data-pos="${pos}"]`);
  if (slotEl && !slotEl.draggable){
    slotEl.draggable = true;
    slotEl.addEventListener('dragstart', onSlotDragStart);
  }
  updateSlotsUI();
  updateHintButtonState();
}

function findTileElById(id){
  return Array.from(bankEl.children).find(c => c.dataset.id === id);
}

function showTileById(id){
  const t = findTileElById(id);
  if (t) t.classList.remove('hidden');
}

function onSlotClick(e){
  const pos = Number(e.currentTarget.dataset.pos);
  if (!slotsState[pos] || !slotsState[pos].tileId) return;
  const tileId = slotsState[pos].tileId;
  showTileById(tileId);
  slotsState[pos] = { ch:'', tileId:null };
  updateSlotsUI();
  updateHintButtonState();
}

function updateSlotsUI(){
  Array.from(slotsEl.children).forEach((el, i) => {
    const st = slotsState[i];
    const content = el.querySelector('.slot-content');
    if (!content) return;
    content.textContent = st.ch === ' ' ? ' ' : (st.ch || '');
    el.classList.remove('wrong');
  });
}

/* ============================
   –ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—É—é –ù–ï–ó–ê–ü–û–õ–ù–ï–ù–ù–£–Æ –±—É–∫–≤—É
   ============================ */
function revealNextLetter(){
  const targetPos = slotsState.findIndex(s => s.ch === '');
  if (targetPos === -1) {
    updateHintButtonState();
    return;
  }
  const letters = Array.from(current);
  const targetLetter = letters[targetPos];
  if (!targetLetter) { updateHintButtonState(); return; }

  const visibleTile = Array.from(bankEl.children).find(t => t.dataset.letter === targetLetter && !t.classList.contains('hidden'));
  if (visibleTile) {
    placeTileToSlot(visibleTile.dataset.id, targetLetter, targetPos);
    updateHintButtonState();
    return;
  }

  const otherPos = slotsState.findIndex((s, idx) => s.ch && s.ch.toLowerCase() === targetLetter.toLowerCase() && idx !== targetPos);
  if (otherPos !== -1) {
    const tileId = slotsState[otherPos].tileId;
    slotsState[otherPos] = { ch:'', tileId:null };
    slotsState[targetPos] = { ch: targetLetter, tileId };
    updateSlotsUI();
    const slotEl = slotsEl.querySelector(`.slot[data-pos="${targetPos}"]`);
    if (slotEl && !slotEl.draggable){
      slotEl.draggable = true;
      slotEl.addEventListener('dragstart', onSlotDragStart);
    }
    updateHintButtonState();
    return;
  }

  updateHintButtonState();
}

/* ============================
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—à–∏–±–æ–∫ + –∞–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥
   ============================ */
function getAssembled(){
  return slotsState.map(s => s.ch === ' ' ? ' ' : (s.ch || '')).join('');
}

function checkAnswer(){
  if (autoNextTimeoutId) { clearTimeout(autoNextTimeoutId); autoNextTimeoutId = null; }

  const assembled = getAssembled();
  const target = current;
  if (assembled.toLowerCase() === target.toLowerCase()){
    if ('speechSynthesis' in window) speechSynthesis.cancel();

    feedback.style.color = 'green';
    feedback.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ';

    // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏ completed (–ø—Ä–æ–≥—Ä–µ—Å—Å), –∏ –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
    completed++;
    idx++;
    saveProgress();
    updateProgress();

    autoNextTimeoutId = setTimeout(() => {
      autoNextTimeoutId = null;
      pickNext();
    }, AUTO_NEXT_DELAY);

  } else {
    if (autoNextTimeoutId) { clearTimeout(autoNextTimeoutId); autoNextTimeoutId = null; }
    feedback.style.color = 'crimson';
    feedback.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–¥—Å–≤–µ—á—É –æ—à–∏–±–æ—á–Ω—ã–µ –±—É–∫–≤—ã.';
    highlightWrongSlots(assembled, target);
  }
}

function highlightWrongSlots(assembled, target){
  const assembledArr = Array.from(assembled);
  const targetArr = Array.from(target);
  const maxLen = Math.max(assembledArr.length, targetArr.length);
  for (let i=0;i<maxLen;i++){
    const a = assembledArr[i] || '';
    const t = targetArr[i] || '';
    const slotEl = slotsEl.querySelector(`.slot[data-pos="${i}"]`);
    if (!slotEl) continue;
    if (t === ' ') continue;
    if (!a || a.toLowerCase() !== t.toLowerCase()){
      slotEl.classList.add('wrong');
    } else {
      slotEl.classList.remove('wrong');
    }
  }
}

/* ============================
   localStorage (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ idx + pool + completed)
   ============================ */
function saveProgress(){
  const payload = { pool, idx, completed };
  localStorage.setItem('russian_scramble_progress', JSON.stringify(payload));
}
function loadProgress(){
  const raw = localStorage.getItem('russian_scramble_progress');
  if (!raw) return false;
  try {
    const obj = JSON.parse(raw);
    if (obj && Array.isArray(obj.pool) && typeof obj.idx === 'number' && typeof obj.completed === 'number'){
      pool = obj.pool;
      idx = obj.idx;
      completed = obj.completed;
      return true;
    }
  }catch(e){}
  return false;
}

/* ============================
   –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –ø–æ–¥—Å–∫–∞–∑–∫–∏
   ============================ */
function updateHintButtonState(){
  const anyEmpty = slotsState.some(s => s.ch === '');
  hintBtn.disabled = !anyEmpty;
}

/* ============================
   –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–ª–æ–≤–∞–º
   ============================ */
function pickNext(){
  if (autoNextTimeoutId) { clearTimeout(autoNextTimeoutId); autoNextTimeoutId = null; }

  if (!pool || pool.length === 0) initPool();
  if (idx >= pool.length){
    alert('–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞! –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ.');
    initPool();
  }
  const w = pool[idx];
  prepareWord(w);
  updateProgress();
}

/* –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ */
document.getElementById('playBtn').addEventListener('click', ()=> speakText(current));
// removed replayBtn handler since button was removed
hintBtn.addEventListener('click', revealNextLetter);
document.getElementById('shuffleBtn').addEventListener('click', ()=> {
  const tiles = Array.from(bankEl.children).map(t => ({id:t.dataset.id, ch:t.dataset.letter}));
  tiles.sort(()=>Math.random()-0.5);
  renderBank(tiles);
  updateHintButtonState();
});
document.getElementById('checkBtn').addEventListener('click', checkAnswer);
document.getElementById('nextBtn').addEventListener('click', ()=> {
  if (autoNextTimeoutId) { clearTimeout(autoNextTimeoutId); autoNextTimeoutId = null; }
  // —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ—Ö–æ–¥ ‚Äî –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º completed, —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
  idx++;
  pickNext();
});

/* drag->bank (–≤–æ–∑–≤—Ä–∞—Ç) */
bankEl.addEventListener('dragover', e => e.preventDefault());
bankEl.addEventListener('drop', e => {
  e.preventDefault();
  try {
    const payload = JSON.parse(e.dataTransfer.getData('text/plain'));
    if (payload.from === 'slot'){
      showTileById(payload.id);
      const pos = payload.pos;
      if (typeof pos === 'number') {
        slotsState[pos] = { ch:'', tileId:null };
        updateSlotsUI();
        updateHintButtonState();
      }
    }
  } catch(err){}
});

/* –ø–µ—Ä–µ–¥ –≤—ã–≥—Ä—É–∑–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –æ—á–∏—Å—Ç–∏–º —Ç–∞–π–º–µ—Ä */
window.addEventListener('beforeunload', () => {
  if (autoNextTimeoutId) clearTimeout(autoNextTimeoutId);
});

/* ============================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   ============================ */
if (!loadProgress()) initPool();
pickNext();
updateProgress();
</script>
</body>
</html>
